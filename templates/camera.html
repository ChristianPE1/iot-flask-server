<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camara - IoT</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #1a1a1a; }
        h1 { font-size: 18px; font-weight: 500; }
        .back-link { color: #666; text-decoration: none; font-size: 14px; }
        .back-link:hover { color: #fff; }
        .video-box { background: #111; border-radius: 12px; overflow: hidden; margin-bottom: 20px; position: relative; aspect-ratio: 16/9; }
        #videoPreview { width: 100%; height: 100%; object-fit: cover; display: block; }
        .rec-badge { position: absolute; top: 16px; left: 16px; display: none; align-items: center; gap: 8px; background: rgba(0,0,0,0.6); padding: 8px 14px; border-radius: 6px; font-size: 12px; }
        .rec-badge.on { display: flex; }
        .rec-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .btn { padding: 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-start { background: #fff; color: #000; }
        .btn-start:hover:not(:disabled) { background: #e5e5e5; }
        .btn-stop { background: #dc2626; color: #fff; }
        .btn-stop:hover:not(:disabled) { background: #b91c1c; }
        .card { background: #111; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .card h3 { font-size: 13px; font-weight: 500; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
        .row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #1a1a1a; font-size: 14px; }
        .row:last-child { border-bottom: none; }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: #fff; }
        .hide { display: none; }
        .show { display: block; }
        .tag { font-size: 12px; padding: 4px 10px; border-radius: 4px; background: #1a1a1a; }
        .tag.ok { background: #166534; color: #22c55e; }
        .tag.err { background: #7f1d1d; color: #ef4444; }
        .tag.load { background: #1e3a5f; color: #3b82f6; }
        .link { display: block; padding: 12px; background: #1a1a1a; border-radius: 6px; margin-bottom: 8px; color: #3b82f6; text-decoration: none; font-size: 13px; word-break: break-all; }
        .link:hover { background: #222; }
        .result { margin-top: 20px; padding: 20px; border-radius: 12px; text-align: center; }
        .result.fire { background: #7f1d1d; border: 1px solid #dc2626; }
        .result.safe { background: #14532d; border: 1px solid #22c55e; }
        .result h4 { font-size: 16px; font-weight: 500; margin-bottom: 8px; }
        .result p { font-size: 13px; color: #999; }
        .bar { margin-top: 16px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        .bar-fill { height: 100%; background: #fff; border-radius: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Captura de Camara</h1>
            <a href="/dashboard" class="back-link">Dashboard</a>
        </header>
        <div class="video-box">
            <video id="videoPreview" autoplay playsinline muted></video>
            <div class="rec-badge" id="recBadge"><span class="rec-dot"></span><span>REC</span></div>
        </div>
        <div class="controls">
            <button class="btn btn-start" id="btnStart" onclick="startCam()">Iniciar Camara</button>
            <button class="btn btn-stop" id="btnStop" onclick="stopCam()" disabled>Detener y Subir</button>
        </div>
        <div class="card">
            <h3>Opciones</h3>
            <div class="row"><label>Foto</label><input type="checkbox" id="optPhoto" checked></div>
            <div class="row"><label>Video</label><input type="checkbox" id="optVideo" checked></div>
            <div class="row"><label>Audio</label><input type="checkbox" id="optAudio" checked></div>
        </div>
        <div class="card hide" id="progCard">
            <h3>Progreso</h3>
            <div class="row" id="pPhoto"><span>Foto</span><span class="tag" id="tPhoto">-</span></div>
            <div class="row" id="pVideo"><span>Video</span><span class="tag" id="tVideo">-</span></div>
            <div class="row" id="pAudio"><span>Audio</span><span class="tag" id="tAudio">-</span></div>
            <div class="row"><span>Analisis IA</span><span class="tag" id="tAI">-</span></div>
        </div>
        <div class="card hide" id="resCard">
            <h3>Resultados</h3>
            <div id="links"></div>
            <div class="result" id="resBox"></div>
        </div>
    </div>
    <script>
        let stream=null, mRec=null, aRec=null, vChunks=[], aChunks=[];
        let photoB=null, videoB=null, audioB=null;

        async function startCam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}},audio:true});
                document.getElementById('videoPreview').srcObject = stream;
                if(document.getElementById('optVideo').checked){
                    const vT=stream.getVideoTracks()[0], aT=stream.getAudioTracks()[0];
                    const rs=new MediaStream([vT,aT]);
                    mRec=new MediaRecorder(rs,{mimeType:'video/webm'});
                    mRec.ondataavailable=e=>{if(e.data.size>0)vChunks.push(e.data);};
                    mRec.start();
                }
                if(document.getElementById('optAudio').checked){
                    const aT=stream.getAudioTracks()[0];
                    if(aT){const as=new MediaStream([aT]);aRec=new MediaRecorder(as,{mimeType:'audio/webm'});aRec.ondataavailable=e=>{if(e.data.size>0)aChunks.push(e.data);};aRec.start();}
                }
                document.getElementById('btnStart').disabled=true;
                document.getElementById('btnStop').disabled=false;
                document.getElementById('recBadge').classList.add('on');
            } catch(e){alert('Error: '+e.message);}
        }

        async function stopCam() {
            document.getElementById('progCard').classList.remove('hide');
            document.getElementById('resCard').classList.add('hide');
            if(document.getElementById('optPhoto').checked&&stream){
                const v=document.getElementById('videoPreview'),c=document.createElement('canvas');
                c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);
                photoB=await new Promise(r=>c.toBlob(r,'image/jpeg',0.9));
            }
            if(mRec&&mRec.state!=='inactive'){mRec.stop();await new Promise(r=>{mRec.onstop=r;});videoB=new Blob(vChunks,{type:'video/webm'});}
            if(aRec&&aRec.state!=='inactive'){aRec.stop();await new Promise(r=>{aRec.onstop=r;});audioB=new Blob(aChunks,{type:'audio/webm'});}
            if(stream)stream.getTracks().forEach(t=>t.stop());
            document.getElementById('btnStart').disabled=false;
            document.getElementById('btnStop').disabled=true;
            document.getElementById('recBadge').classList.remove('on');
            await upload();
        }

        async function upload() {
            const r={photo_url:null,photo_gcs_uri:null,video_url:null,video_gcs_uri:null,audio_url:null};
            if(photoB){
                setT('tPhoto','load','Subiendo');
                try{const fd=new FormData();fd.append('photo',photoB,'c.jpg');const res=await fetch('/upload/photo',{method:'POST',body:fd});const d=await res.json();
                if(d.success){r.photo_url=d.url;r.photo_gcs_uri=d.gcs_uri;setT('tPhoto','ok','OK');}else{setT('tPhoto','err','Error');}}
                catch(e){setT('tPhoto','err','Error');}
            }else{document.getElementById('pPhoto').style.display='none';}
            if(videoB){
                setT('tVideo','load','Subiendo');
                try{const fd=new FormData();fd.append('video',videoB,'c.webm');const res=await fetch('/upload/video',{method:'POST',body:fd});const d=await res.json();
                if(d.success){r.video_url=d.url;r.video_gcs_uri=d.gcs_uri;setT('tVideo','ok','OK');}else{setT('tVideo','err','Error');}}
                catch(e){setT('tVideo','err','Error');}
            }else{document.getElementById('pVideo').style.display='none';}
            if(audioB){
                setT('tAudio','load','Subiendo');
                try{const fd=new FormData();fd.append('audio',audioB,'c.webm');const res=await fetch('/upload/audio',{method:'POST',body:fd});const d=await res.json();
                if(d.success){r.audio_url=d.url;setT('tAudio','ok','OK');}else{setT('tAudio','err','Error');}}
                catch(e){setT('tAudio','err','Error');}
            }else{document.getElementById('pAudio').style.display='none';}
            setT('tAI','load','Analizando');
            try{const res=await fetch('/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(r)});const d=await res.json();setT('tAI','ok','OK');showRes(r,d);}
            catch(e){setT('tAI','err','Error');showRes(r,null);}
            vChunks=[];aChunks=[];photoB=null;videoB=null;audioB=null;stream=null;mRec=null;aRec=null;
        }

        function setT(id,c,t){const e=document.getElementById(id);e.className='tag '+c;e.textContent=t;}

        function showRes(f,a){
            document.getElementById('resCard').classList.remove('hide');
            let h='';
            if(f.photo_url)h+='<a href="'+f.photo_url+'" target="_blank" class="link">Foto</a>';
            if(f.video_url)h+='<a href="'+f.video_url+'" target="_blank" class="link">Video</a>';
            if(f.audio_url)h+='<a href="'+f.audio_url+'" target="_blank" class="link">Audio</a>';
            document.getElementById('links').innerHTML=h||'<p style="color:#666;font-size:13px;">Sin archivos</p>';
            const b=document.getElementById('resBox');
            if(a&&a.success!==false){
                const fire=a.fire_detected,conf=(a.confidence*100).toFixed(1);
                b.className='result '+(fire?'fire':'safe');
                b.innerHTML='<h4>'+(fire?'Fuego Detectado':'Sin Fuego')+'</h4><p>Confianza: '+conf+'%</p><div class="bar"><div class="bar-fill" style="width:'+conf+'%"></div></div>';
            }else{b.className='result';b.innerHTML='<h4>Error en analisis</h4>';}
        }
    </script>
</body>
</html>
