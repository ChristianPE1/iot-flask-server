<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∑ C√°mara IoT - Captura Manual</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-idle { background: #888; animation: none; }
        .status-recording { background: #f44336; }
        .status-uploading { background: #ff9800; }
        .status-analyzing { background: #2196f3; }
        .status-complete { background: #4caf50; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Video Preview */
        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        #videoPreview {
            width: 100%;
            display: block;
            max-height: 400px;
            object-fit: cover;
        }

        .recording-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #f44336;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
        }

        .recording-badge.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rec-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
        }

        /* Capture Options */
        .capture-options {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .capture-options h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .option-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .option-row:last-child {
            border-bottom: none;
        }

        .option-row label {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4caf50;
        }

        /* Progress Section */
        .progress-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            gap: 10px;
        }

        .progress-icon {
            width: 30px;
            text-align: center;
            font-size: 20px;
        }

        .progress-text {
            flex: 1;
        }

        .progress-status {
            font-size: 20px;
        }

        /* Results Section */
        .results-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .result-item h4 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-item a {
            color: #64b5f6;
            word-break: break-all;
            font-size: 12px;
        }

        /* Analysis Result */
        .analysis-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .analysis-result.fire {
            background: linear-gradient(135deg, #ff5252, #d32f2f);
        }

        .analysis-result.no-fire {
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }

        .analysis-result h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .confidence-bar {
            background: rgba(0,0,0,0.3);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .confidence-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 1s ease;
        }

        /* Links */
        .links {
            text-align: center;
            margin-top: 20px;
        }

        .links a {
            color: #64b5f6;
            text-decoration: none;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ C√°mara IoT - Captura Manual</h1>

        <!-- Status Card -->
        <div class="status-card">
            <span class="status-indicator status-idle" id="statusIndicator"></span>
            <span id="statusText">Listo para capturar</span>
        </div>

        <!-- Video Preview -->
        <div class="video-container">
            <video id="videoPreview" autoplay playsinline muted></video>
            <div class="recording-badge" id="recordingBadge">
                <span class="rec-dot"></span>
                <span>GRABANDO</span>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="controls">
            <button class="btn btn-start" id="btnStart" onclick="iniciarCaptura()">
                ‚ñ∂Ô∏è Iniciar C√°mara
            </button>
            <button class="btn btn-stop" id="btnStop" onclick="detenerCaptura()" disabled>
                ‚èπÔ∏è Detener y Subir
            </button>
        </div>

        <!-- Capture Options -->
        <div class="capture-options">
            <h3>‚öôÔ∏è Opciones de Captura</h3>
            <div class="option-row">
                <label>
                    <input type="checkbox" id="capturePhoto" checked>
                    üì∑ Capturar Foto
                </label>
            </div>
            <div class="option-row">
                <label>
                    <input type="checkbox" id="captureVideo" checked>
                    üé• Grabar Video
                </label>
            </div>
            <div class="option-row">
                <label>
                    <input type="checkbox" id="captureAudio" checked>
                    üé§ Grabar Audio
                </label>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <h3>üì§ Subiendo archivos...</h3>
            <div class="progress-item" id="progressPhoto">
                <span class="progress-icon">üì∑</span>
                <span class="progress-text">Foto</span>
                <span class="progress-status">‚è≥</span>
            </div>
            <div class="progress-item" id="progressVideo">
                <span class="progress-icon">üé•</span>
                <span class="progress-text">Video</span>
                <span class="progress-status">‚è≥</span>
            </div>
            <div class="progress-item" id="progressAudio">
                <span class="progress-icon">üé§</span>
                <span class="progress-text">Audio</span>
                <span class="progress-status">‚è≥</span>
            </div>
            <div class="progress-item" id="progressAnalysis">
                <span class="progress-icon">ü§ñ</span>
                <span class="progress-text">An√°lisis Vertex AI</span>
                <span class="progress-status">‚è≥</span>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h3>üìÅ Archivos Capturados</h3>
            <div id="fileResults"></div>
            
            <div class="analysis-result" id="analysisResult">
                <h2 id="analysisTitle">Analizando...</h2>
                <p id="analysisDescription"></p>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                </div>
                <p id="confidenceText"></p>
            </div>
        </div>

        <!-- Links -->
        <div class="links">
            <a href="/dashboard">üìä Ver Dashboard</a>
            <a href="/">üè† Inicio</a>
        </div>
    </div>

    <script>
        let videoStream = null;
        let mediaRecorder = null;
        let audioRecorder = null;
        let videoChunks = [];
        let audioChunks = [];
        let isRecording = false;

        // Captured files
        let capturedPhoto = null;
        let capturedVideo = null;
        let capturedAudio = null;

        async function iniciarCaptura() {
            try {
                // Request camera and microphone access
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = videoStream;

                // Start video recording
                if (document.getElementById('captureVideo').checked) {
                    const videoTrack = videoStream.getVideoTracks()[0];
                    const audioTrack = videoStream.getAudioTracks()[0];
                    
                    const recordStream = new MediaStream([videoTrack, audioTrack]);
                    mediaRecorder = new MediaRecorder(recordStream, { mimeType: 'video/webm' });
                    
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) videoChunks.push(e.data);
                    };
                    
                    mediaRecorder.start();
                }

                // Start audio-only recording
                if (document.getElementById('captureAudio').checked) {
                    const audioTrack = videoStream.getAudioTracks()[0];
                    if (audioTrack) {
                        const audioStream = new MediaStream([audioTrack]);
                        audioRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
                        
                        audioRecorder.ondataavailable = (e) => {
                            if (e.data.size > 0) audioChunks.push(e.data);
                        };
                        
                        audioRecorder.start();
                    }
                }

                isRecording = true;
                updateUI('recording');

            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Error al acceder a la c√°mara: ' + error.message);
            }
        }

        async function detenerCaptura() {
            if (!isRecording) return;

            updateUI('uploading');

            // Capture photo from video stream
            if (document.getElementById('capturePhoto').checked && videoStream) {
                const video = document.getElementById('videoPreview');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                capturedPhoto = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.9);
                });
            }

            // Stop video recording
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                await new Promise(resolve => {
                    mediaRecorder.onstop = resolve;
                });
                capturedVideo = new Blob(videoChunks, { type: 'video/webm' });
            }

            // Stop audio recording
            if (audioRecorder && audioRecorder.state !== 'inactive') {
                audioRecorder.stop();
                await new Promise(resolve => {
                    audioRecorder.onstop = resolve;
                });
                capturedAudio = new Blob(audioChunks, { type: 'audio/webm' });
            }

            // Stop video stream
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }

            isRecording = false;

            // Upload files to Cloud Storage
            await uploadFiles();
        }

        async function uploadFiles() {
            const results = {
                photo_url: null,
                video_url: null,
                audio_url: null
            };

            document.getElementById('progressSection').classList.add('active');

            // Upload photo
            if (capturedPhoto) {
                updateProgress('progressPhoto', 'uploading');
                try {
                    const formData = new FormData();
                    formData.append('photo', capturedPhoto, 'capture.jpg');
                    
                    const response = await fetch('/upload/photo', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.url) {
                        results.photo_url = data.url;
                        updateProgress('progressPhoto', 'success');
                    } else {
                        updateProgress('progressPhoto', 'error');
                    }
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    updateProgress('progressPhoto', 'error');
                }
            } else {
                document.getElementById('progressPhoto').style.display = 'none';
            }

            // Upload video
            if (capturedVideo) {
                updateProgress('progressVideo', 'uploading');
                try {
                    const formData = new FormData();
                    formData.append('video', capturedVideo, 'capture.webm');
                    
                    const response = await fetch('/upload/video', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.url) {
                        results.video_url = data.url;
                        updateProgress('progressVideo', 'success');
                    } else {
                        updateProgress('progressVideo', 'error');
                    }
                } catch (error) {
                    console.error('Error uploading video:', error);
                    updateProgress('progressVideo', 'error');
                }
            } else {
                document.getElementById('progressVideo').style.display = 'none';
            }

            // Upload audio
            if (capturedAudio) {
                updateProgress('progressAudio', 'uploading');
                try {
                    const formData = new FormData();
                    formData.append('audio', capturedAudio, 'capture.webm');
                    
                    const response = await fetch('/upload/audio', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.url) {
                        results.audio_url = data.url;
                        updateProgress('progressAudio', 'success');
                    } else {
                        updateProgress('progressAudio', 'error');
                    }
                } catch (error) {
                    console.error('Error uploading audio:', error);
                    updateProgress('progressAudio', 'error');
                }
            } else {
                document.getElementById('progressAudio').style.display = 'none';
            }

            // Analyze with Vertex AI
            updateProgress('progressAnalysis', 'uploading');
            updateUI('analyzing');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(results)
                });

                const analysisData = await response.json();
                updateProgress('progressAnalysis', 'success');
                
                showResults(results, analysisData);

            } catch (error) {
                console.error('Error analyzing:', error);
                updateProgress('progressAnalysis', 'error');
                showResults(results, null);
            }

            updateUI('complete');
            resetCapture();
        }

        function showResults(files, analysis) {
            const resultsSection = document.getElementById('resultsSection');
            const fileResults = document.getElementById('fileResults');
            const analysisResult = document.getElementById('analysisResult');
            
            resultsSection.classList.add('active');

            // Show file links
            let filesHtml = '';
            if (files.photo_url) {
                filesHtml += `
                    <div class="result-item">
                        <h4>üì∑ Foto</h4>
                        <a href="${files.photo_url}" target="_blank">${files.photo_url}</a>
                    </div>
                `;
            }
            if (files.video_url) {
                filesHtml += `
                    <div class="result-item">
                        <h4>üé• Video</h4>
                        <a href="${files.video_url}" target="_blank">${files.video_url}</a>
                    </div>
                `;
            }
            if (files.audio_url) {
                filesHtml += `
                    <div class="result-item">
                        <h4>üé§ Audio</h4>
                        <a href="${files.audio_url}" target="_blank">${files.audio_url}</a>
                    </div>
                `;
            }
            fileResults.innerHTML = filesHtml;

            // Show analysis result
            if (analysis && analysis.results) {
                const fireDetected = analysis.fire_detected;
                const confidence = (analysis.confidence * 100).toFixed(1);

                analysisResult.className = 'analysis-result ' + (fireDetected ? 'fire' : 'no-fire');
                
                document.getElementById('analysisTitle').textContent = fireDetected 
                    ? 'üî• ¬°FUEGO DETECTADO!' 
                    : '‚úÖ Sin fuego detectado';
                
                document.getElementById('analysisDescription').textContent = fireDetected
                    ? 'Vertex AI ha detectado fuego o humo en las capturas. Se ha enviado una alerta por email.'
                    : 'No se detect√≥ fuego ni humo en las capturas analizadas.';
                
                document.getElementById('confidenceFill').style.width = confidence + '%';
                document.getElementById('confidenceText').textContent = `Confianza: ${confidence}%`;
            } else {
                analysisResult.className = 'analysis-result';
                document.getElementById('analysisTitle').textContent = '‚ö†Ô∏è An√°lisis no disponible';
                document.getElementById('analysisDescription').textContent = 'No se pudo completar el an√°lisis con Vertex AI.';
            }
        }

        function updateProgress(elementId, status) {
            const element = document.getElementById(elementId);
            const statusSpan = element.querySelector('.progress-status');
            
            switch(status) {
                case 'uploading':
                    statusSpan.textContent = '‚è≥';
                    break;
                case 'success':
                    statusSpan.textContent = '‚úÖ';
                    break;
                case 'error':
                    statusSpan.textContent = '‚ùå';
                    break;
            }
        }

        function updateUI(state) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const recordingBadge = document.getElementById('recordingBadge');

            indicator.className = 'status-indicator';

            switch(state) {
                case 'recording':
                    indicator.classList.add('status-recording');
                    statusText.textContent = 'üî¥ Grabando...';
                    btnStart.disabled = true;
                    btnStop.disabled = false;
                    recordingBadge.classList.add('active');
                    break;
                case 'uploading':
                    indicator.classList.add('status-uploading');
                    statusText.textContent = 'üì§ Subiendo archivos...';
                    btnStart.disabled = true;
                    btnStop.disabled = true;
                    recordingBadge.classList.remove('active');
                    break;
                case 'analyzing':
                    indicator.classList.add('status-analyzing');
                    statusText.textContent = 'ü§ñ Analizando con Vertex AI...';
                    break;
                case 'complete':
                    indicator.classList.add('status-complete');
                    statusText.textContent = '‚úÖ Captura completada';
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                    break;
                default:
                    indicator.classList.add('status-idle');
                    statusText.textContent = 'Listo para capturar';
                    btnStart.disabled = false;
                    btnStop.disabled = true;
            }
        }

        function resetCapture() {
            videoChunks = [];
            audioChunks = [];
            capturedPhoto = null;
            capturedVideo = null;
            capturedAudio = null;
            videoStream = null;
            mediaRecorder = null;
            audioRecorder = null;
        }
    </script>
</body>
</html>
