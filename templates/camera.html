<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camara - IoT Fire Detection</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0a0a0a; 
            color: #fff; 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 800px; margin: 0 auto; }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid #1a1a1a; 
        }
        h1 { font-size: 20px; font-weight: 500; }
        .back-link { color: #666; text-decoration: none; font-size: 14px; }
        .back-link:hover { color: #fff; }
        
        .video-container { 
            background: #111; 
            border-radius: 12px; 
            overflow: hidden; 
            margin-bottom: 20px; 
            position: relative; 
        }
        #video { 
            width: 100%; 
            display: block;
            background: #000;
        }
        #canvas { display: none; }
        
        .rec-indicator { 
            position: absolute; 
            top: 16px; 
            left: 16px; 
            display: none; 
            align-items: center; 
            gap: 8px; 
            background: rgba(0,0,0,0.8); 
            padding: 8px 14px; 
            border-radius: 6px; 
            font-size: 12px; 
        }
        .rec-indicator.active { display: flex; }
        .rec-dot { 
            width: 8px; 
            height: 8px; 
            background: #ef4444; 
            border-radius: 50%; 
            animation: pulse 1s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.3; } 
        }
        
        .controls { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .btn-camera { 
            grid-column: 1 / -1;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #999;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-camera:hover { background: #222; color: #fff; }
        .btn { 
            padding: 16px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: #fff; color: #000; }
        .btn-primary:hover:not(:disabled) { background: #e5e5e5; }
        .btn-danger { background: #dc2626; color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #b91c1c; }
        .btn-success { background: #16a34a; color: #fff; }
        .btn-success:hover:not(:disabled) { background: #15803d; }
        .btn-full { grid-column: 1 / -1; }
        
        .status-card { 
            background: #111; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .status-card h3 { 
            font-size: 12px; 
            font-weight: 500; 
            color: #666; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 16px; 
        }
        .status-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px solid #1a1a1a; 
            font-size: 14px; 
        }
        .status-item:last-child { border-bottom: none; }
        .status-label { color: #999; }
        .status-value { font-weight: 500; }
        
        .badge { 
            display: inline-block;
            padding: 4px 10px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 500;
        }
        .badge-success { background: #166534; color: #22c55e; }
        .badge-error { background: #7f1d1d; color: #ef4444; }
        .badge-info { background: #1e3a5f; color: #3b82f6; }
        .badge-gray { background: #1a1a1a; color: #666; }
        
        .result-box { 
            padding: 24px; 
            border-radius: 12px; 
            text-align: center; 
            margin-top: 20px;
        }
        .result-box.fire { 
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); 
            border: 1px solid #dc2626; 
        }
        .result-box.safe { 
            background: linear-gradient(135deg, #14532d 0%, #166534 100%); 
            border: 1px solid #22c55e; 
        }
        .result-box h2 { font-size: 24px; margin-bottom: 8px; }
        .result-box p { font-size: 14px; color: rgba(255,255,255,0.8); }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• Detecci√≥n de Incendios - C√°mara</h1>
            <a href="/dashboard" class="back-link">‚Üê Dashboard</a>
        </header>

        <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
            <div class="rec-indicator" id="recIndicator">
                <span class="rec-dot"></span>
                <span>GRABANDO</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn-camera" id="switchCameraBtn" onclick="switchCamera()">
                üîÑ Cambiar C√°mara (Frontal/Trasera)
            </button>
            <button class="btn btn-primary" id="startBtn" onclick="startRecording()">
                Iniciar Grabaci√≥n
            </button>
            <button class="btn btn-danger" id="stopBtn" onclick="stopRecording()" disabled>
                Detener y Analizar
            </button>
        </div>

        <div class="status-card">
            <h3>Estado de Captura</h3>
            <div class="status-item">
                <span class="status-label">Foto</span>
                <span class="status-value" id="photoStatus">
                    <span class="badge badge-gray">Pendiente</span>
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">Video</span>
                <span class="status-value" id="videoStatus">
                    <span class="badge badge-gray">Pendiente</span>
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">Audio</span>
                <span class="status-value" id="audioStatus">
                    <span class="badge badge-gray">Pendiente</span>
                </span>
            </div>
        </div>

        <div id="resultContainer"></div>
    </div>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let mediaRecorder = null;
        let audioRecorder = null;
        let videoChunks = [];
        let audioChunks = [];
        let stream = null;
        let audioStream = null;
        let currentFacingMode = 'user'; // 'user' = frontal, 'environment' = trasera

        // Iniciar c√°mara al cargar
        async function initCamera(facingMode = 'user') {
            try {
                // Detener stream anterior si existe
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: { 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 },
                        facingMode: facingMode
                    }, 
                    audio: false 
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                currentFacingMode = facingMode;
                console.log(`‚úÖ C√°mara iniciada (${facingMode === 'user' ? 'Frontal' : 'Trasera'})`);
            } catch (error) {
                console.error('‚ùå Error al acceder a la c√°mara:', error);
                alert('Error: No se puede acceder a la c√°mara. Verifica los permisos.');
            }
        }

        async function switchCamera() {
            const newMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await initCamera(newMode);
        }

        async function startRecording() {
            try {
                videoChunks = [];
                audioChunks = [];

                // Iniciar grabaci√≥n de video
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0) {
                        videoChunks.push(e.data);
                    }
                };
                mediaRecorder.start();
                console.log('üé• Grabaci√≥n de video iniciada');

                // Iniciar grabaci√≥n de audio separada
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                audioRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
                audioRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };
                audioRecorder.start();
                console.log('üé§ Grabaci√≥n de audio iniciada');

                // UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recIndicator').classList.add('active');

                updateStatus('photoStatus', 'info', 'Esperando...');
                updateStatus('videoStatus', 'info', 'Grabando...');
                updateStatus('audioStatus', 'info', 'Grabando...');

            } catch (error) {
                console.error('‚ùå Error al iniciar grabaci√≥n:', error);
                alert('Error al iniciar la grabaci√≥n: ' + error.message);
            }
        }

        async function stopRecording() {
            console.log('‚èπÔ∏è Deteniendo grabaci√≥n...');

            // Desactivar botones
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recIndicator').classList.remove('active');

            // Capturar foto
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Detener grabaciones
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (audioRecorder && audioRecorder.state !== 'inactive') {
                audioRecorder.stop();
            }

            // Esperar a que terminen las grabaciones
            await new Promise(resolve => setTimeout(resolve, 500));

            // Procesar y subir archivos
            await uploadAndAnalyze();
        }

        async function uploadAndAnalyze() {
            try {
                updateStatus('photoStatus', 'info', 'Subiendo...');
                updateStatus('videoStatus', 'info', 'Subiendo...');
                updateStatus('audioStatus', 'info', 'Subiendo...');

                // 1. SUBIR FOTO
                const photoBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                console.log(`üì∏ Foto capturada: ${photoBlob.size} bytes`);
                
                const photoFormData = new FormData();
                photoFormData.append('photo', photoBlob, 'capture.jpg');
                
                const photoRes = await fetch('/upload/photo', {
                    method: 'POST',
                    body: photoFormData
                });
                const photoData = await photoRes.json();
                console.log('üì∏ Foto subida:', photoData);
                
                if (photoData.success) {
                    updateStatus('photoStatus', 'success', '‚úì Subida');
                } else {
                    updateStatus('photoStatus', 'error', '‚úó Error');
                }

                // 2. SUBIR VIDEO
                const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                console.log(`üé• Video capturado: ${videoBlob.size} bytes`);
                
                const videoFormData = new FormData();
                videoFormData.append('video', videoBlob, 'capture.webm');
                
                const videoRes = await fetch('/upload/video', {
                    method: 'POST',
                    body: videoFormData
                });
                const videoData = await videoRes.json();
                console.log('üé• Video subido:', videoData);
                
                if (videoData.success) {
                    updateStatus('videoStatus', 'success', '‚úì Subida');
                } else {
                    updateStatus('videoStatus', 'error', '‚úó Error');
                }

                // 3. SUBIR AUDIO
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                console.log(`üé§ Audio capturado: ${audioBlob.size} bytes`);
                
                const audioFormData = new FormData();
                audioFormData.append('audio', audioBlob, 'capture.webm');
                
                const audioRes = await fetch('/upload/audio', {
                    method: 'POST',
                    body: audioFormData
                });
                const audioData = await audioRes.json();
                console.log('üé§ Audio subido:', audioData);
                
                if (audioData.success) {
                    updateStatus('audioStatus', 'success', '‚úì Subida');
                } else {
                    updateStatus('audioStatus', 'error', '‚úó Error');
                }

                // 4. ANALIZAR CON VERTEX AI
                console.log('üî• Analizando con Vertex AI...');
                const analyzeRes = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        photo_url: photoData.url,
                        photo_gcs_uri: photoData.gcs_uri,
                        video_url: videoData.url,
                        video_gcs_uri: videoData.gcs_uri,
                        audio_url: audioData.url
                    })
                });

                const analyzeData = await analyzeRes.json();
                console.log('üî• Resultado del an√°lisis:', analyzeData);

                // Mostrar resultado
                showResult(analyzeData);

                // Limpiar y reiniciar
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                
                videoChunks = [];
                audioChunks = [];
                
                document.getElementById('startBtn').disabled = false;

            } catch (error) {
                console.error('‚ùå Error en upload/an√°lisis:', error);
                alert('Error: ' + error.message);
                
                updateStatus('photoStatus', 'error', '‚úó Error');
                updateStatus('videoStatus', 'error', '‚úó Error');
                updateStatus('audioStatus', 'error', '‚úó Error');
                
                document.getElementById('startBtn').disabled = false;
            }
        }

        function updateStatus(elementId, type, text) {
            const badgeClass = {
                'success': 'badge-success',
                'error': 'badge-error',
                'info': 'badge-info',
                'gray': 'badge-gray'
            }[type] || 'badge-gray';
            
            document.getElementById(elementId).innerHTML = 
                `<span class="badge ${badgeClass}">${text}</span>`;
        }

        function showResult(data) {
            const container = document.getElementById('resultContainer');
            
            if (data.fire_detected) {
                const confidence = (data.confidence * 100).toFixed(1);
                container.innerHTML = `
                    <div class="result-box fire">
                        <h2>üî• FUEGO DETECTADO</h2>
                        <p>Confianza: ${confidence}%</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="result-box safe">
                        <h2>‚úì Sin Fuego</h2>
                        <p>No se detectaron signos de incendio</p>
                    </div>
                `;
            }
        }

        // Iniciar c√°mara al cargar la p√°gina
        window.addEventListener('load', initCamera);
    </script>
</body>
</html>
